# Copilot Instructions for Free Dispatcher

- **Architecture**: Desktop-first Electron shell launching FastAPI backend (dynamic local port) plus React 19/Vite renderer. Backend runs from system Python in dev or bundled PyInstaller binary in packaged builds; renderer asks main process for the backend URL via `electronAPI.getBackendUrl()` exposed in [../app/electron/preload.js](../app/electron/preload.js).
- **Backend entry**: [../app/electron/main.js](../app/electron/main.js) finds an open port, sets `BACKEND_PORT`, `USER_DATA_DIR`, and `DATABASE_URL` (defaults to SQLite under the OS user data dir), then spawns uvicorn (`python -m uvicorn main:app --host 127.0.0.1 --port <port>`) or the bundled `backend-app` binary. If the backend exits, the app quits.
- **Frontend entry**: Vite SPA at [../app/src/main.jsx](../app/src/main.jsx) renders [../app/src/App.jsx](../app/src/App.jsx), a large generic CRUD UI using an `EntityManager` for Layouts, Districts, and Dispatchers. API helpers live in [../app/src/api.js](../app/src/api.js) and resolve the backend base URL dynamically (Electron IPC or `API_URL`/hostname:8001 fallback).
- **Data model**: SQLAlchemy models in [../app/backend/models.py](../app/backend/models.py) define three tables: `layouts` (name, start/end dates, city/state), `districts` (FK to layouts, channel/frequency), `dispatchers` (name, cell, optional layout/district FK). Pydantic schemas in [../app/backend/schemas.py](../app/backend/schemas.py) mirror these; `LayoutRead.key` serializes to the ID for frontend use.
- **API surface**: FastAPI routes in [../app/backend/main.py](../app/backend/main.py) expose CRUD for layouts, districts (nested under layouts), and dispatchers. There are placeholder client calls for modules/trains in `api.js` but no server endpointsâ€”add backend routes before wiring new UI actions. `/status` returns version/port/IP info; `/schema` reflects DB tables/relationships for the ReactFlow diagram.
- **Database config**: [../app/backend/database.py](../app/backend/database.py) builds an async engine from `DATABASE_URL` (default SQLite). On startup `Base.metadata.create_all` runs against a sync engine; Alembic directories exist but are not invoked. When adding tables/columns, update models and schemas, then consider migrations; otherwise create_all will auto-create in SQLite.
- **Dev workflow (Electron default)**:
  - `npm install` in `app/`.
  - `cd app/backend && pip install -r requirements.txt`.
  - Run `npm run electron:dev` (starts backend on a random 127.0.0.1 port, opens renderer at localhost:5173).
- **Dev workflow (browser + API)**: `npm run backend` (uvicorn on 8001) plus `npm run start-frontend` (waits for `/docs`) or `npm run dev:all` to run both. Renderer assumes backend at `http://<host>:8001` when not in Electron.
- **Packaging**: `npm run backend:bundle` builds a one-file backend binary into `app/backend/dist` (PyInstaller entrypoint [../app/backend/run_backend.py](../app/backend/run_backend.py)). `npm run build` builds the renderer. `npm run electron` runs packaged layout from `dist`. `npm run electron:build` generates installers (dmg/nsis/AppImage) and ships backend via `extraResources` in `package.json`.
- **Environment toggles**: `DATABASE_URL` switches DB (use Postgres by setting it before launching Electron); `PYTHON` selects interpreter in dev; `ELECTRON_DEV=1` enables devtools and loads Vite dev server.
- **LAN/IP**: Backend reports available IPs/port via `/ip` and `/status`. Electron binds backend to 127.0.0.1; for LAN APIs use the standalone backend script or adjust host envs.
- **UI patterns**: `EntityManager` handles CRUD tables/forms with popup modals. It expects list endpoints returning arrays and create/update endpoints accepting plain JSON bodies. Deleting uses confirmation dialogs. Layout selection triggers nested District and Dispatcher dropdown refreshes.
- **Known gaps**: Frontend defines Modules/Trains helpers but backend lacks these tables/routes; add models/schemas/routes first. Error handling is minimal; backend exceptions bubble as plain text.
- **Data location**: Default SQLite file lives under the Electron user data dir (`app.getPath('userData')/dispatcher.db`); scripts or tests should clean this path when resetting state.
- **Git LFS**: Binary assets tracked via LFS; run `./app/scripts/lfs-helper.sh install` before working with media. See [../docs/GIT_LFS_GUIDE.md](../docs/GIT_LFS_GUIDE.md) for usage.
 - **Schema diagram caveat**: [../app/src/DataSchematic.jsx](../app/src/DataSchematic.jsx#L1-L50) fetches `http://localhost:8001/schema` directly; it only works if the backend also runs on 8001 (e.g., `npm run backend`) or if you proxy that path in dev.
 - **Docs freshness**: Root [../README.md](../README.md) is outdated (Docker-first). Prefer [../app/README.md](../app/README.md) for current Electron/Vite workflow.

If any of these directions feel incomplete or you want more detail on a particular flow (e.g., packaging or adding new entities), let me know and I will refine this.